<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pentest Estimator Dashboard</title>
    <link rel="stylesheet" href="/css/style.css">
    <script>
        // Simple script to retain form values if needed, though render handles it mostly
    </script>
</head>

<body>
    <div class="dashboard-container">
        <header>
            <div style="display: flex; align-items: center; gap: 1rem;">
                <!-- Avatar -->
                <div
                    style="width: 40px; height: 40px; background: #e0e7ff; color: #4f46e5; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">
                    <%= user.username.charAt(0).toUpperCase() %>
                </div>
                <div>
                    <h1 style="margin: 0; font-size: 1.5rem;">‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏£‡∏≤‡∏Ñ‡∏≤ Pentest</h1>
                    <span class="text-muted" style="font-size: 0.9rem;">‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏à‡∏≤‡∏∞‡∏£‡∏∞‡∏ö‡∏ö</span>
                </div>
            </div>
            <div style="display: flex; gap: 10px;">
                <a href="/profile" class="btn btn-secondary" style="width: auto;">‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</a>
                <a href="/auth/logout" class="btn logout-btn">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</a>
            </div>
        </header>

        <div class="content">
            <!-- Alert Messages -->
            <% if (error) { %>
                <div class="error">
                    <%= error %>
                </div>
                <% } %>
                    <% if (success) { %>
                        <div
                            style="background-color: #d1fae5; color: #065f46; padding: 0.75rem; border-radius: 0.5rem; margin-bottom: 1.5rem; text-align: center; border: 1px solid #a7f3d0;">
                            <%= success %>
                        </div>
                        <% } %>

                            <% if (previewResult) { %>
                                <!-- PREVIEW SECTION -->
                                <div class="card"
                                    style="border: 2px solid var(--primary-color); background-color: #f0f9ff;">
                                    <h3 style="color: var(--primary-color);">üìä ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì (Evaluation Result)</h3>

                                    <div
                                        style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                                        <div>
                                            <strong>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:</strong>
                                            <%= previewResult.client_name %><br>
                                                <strong>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:</strong>
                                                <%= previewResult.device_type %> (<%= previewResult.test_type %>)
                                        </div>
                                        <div style="text-align: right;">
                                            <span
                                                style="font-size: 1.5rem; font-weight: bold; color: var(--primary-color);">
                                                <%= previewResult.estimated_days %> Man-Days
                                            </span>
                                            <br>
                                            <span class="text-muted">Functions: <%= previewResult.function_count %> |
                                                    Platforms: <%= previewResult.platform_count %></span>
                                        </div>
                                    </div>

                                    <div style="display: flex; gap: 1rem;">
                                        <!-- Confirm Form -->
                                        <form action="/dashboard/save" method="POST" style="flex: 1;">
                                            <input type="hidden" name="client_name"
                                                value="<%= previewResult.client_name %>">
                                            <input type="hidden" name="device_type"
                                                value="<%= previewResult.device_type %>">
                                            <input type="hidden" name="test_type"
                                                value="<%= previewResult.test_type %>">
                                            <input type="hidden" name="function_count"
                                                value="<%= previewResult.function_count %>">
                                            <input type="hidden" name="platform_count"
                                                value="<%= previewResult.platform_count %>">
                                            <input type="hidden" name="estimated_days"
                                                value="<%= previewResult.estimated_days %>">
                                            <button type="submit" class="btn" style="background-color: #059669;">‚úîÔ∏è
                                                ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (Save)</button>
                                        </form>

                                        <!-- Cancel Button -->
                                        <a href="/dashboard" class="btn"
                                            style="flex: 1; background-color: #6b7280; line-height: 48px; padding: 0;">‚ùå
                                            ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å / ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà</a>
                                    </div>
                                </div>
                                <% } else { %>
                                    <!-- Estimation Form -->
                                    <div class="card">
                                        <h3>üõ†Ô∏è ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÉ‡∏´‡∏°‡πà (New Estimation)</h3>
                                        <form action="/dashboard/estimate" method="POST">
                                            <div class="form-group">
                                                <label for="client_name">‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (Client Name)</label>
                                                <input type="text" id="client_name" name="client_name"
                                                    placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤" required>
                                            </div>

                                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                                <div class="form-group">
                                                    <label for="device_type">‡∏ä‡∏ô‡∏¥‡∏î‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á (Device Type)</label>
                                                    <select id="device_type" name="device_type"
                                                        style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; background: #f9fafb;">
                                                        <option value="web_application">Web Application</option>
                                                        <option value="mobile_application">Mobile Application</option>
                                                        <option value="api_webservice">API / Webservice</option>
                                                        <option value="infrastructure">Infrastructure</option>
                                                    </select>
                                                </div>
                                                <div class="form-group">
                                                    <label for="test_type">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö (Test Type)</label>
                                                    <select id="test_type" name="test_type"
                                                        style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; background: #f9fafb;">
                                                        <option value="graybox">Gray Box (‡∏°‡∏µ User/Pass)</option>
                                                        <option value="blackbox">Black Box (‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏≠‡∏∞‡πÑ‡∏£‡πÄ‡∏•‡∏¢)</option>
                                                    </select>
                                                </div>
                                            </div>

                                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                                <div class="form-group">
                                                    <label for="function_count">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å (Functions)</label>
                                                    <input type="number" id="function_count" name="function_count"
                                                        placeholder="0" min="1" required
                                                        style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem;">
                                                </div>
                                                <div class="form-group">
                                                    <label for="platform_count">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô Platform (iOS/Android/Web)</label>
                                                    <input type="number" id="platform_count" name="platform_count"
                                                        value="1" min="1" required
                                                        style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem;">
                                                </div>
                                            </div>

                                            <button type="submit" class="btn">üöÄ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤ (Calculate)</button>
                                        </form>
                                    </div>
                                    <% } %>

                                        <!-- History Table -->
                                        <div class="card">
                                            <h3>üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô (History)</h3>
                                            <% if (estimations && estimations.length> 0) { %>
                                                <div style="overflow-x: auto;">
                                                    <table
                                                        style="width: 100%; border-collapse: collapse; margin-top: 1rem;">
                                                        <thead>
                                                            <tr style="background: #f3f4f6; text-align: left;">
                                                                <th
                                                                    style="padding: 0.75rem; border-bottom: 2px solid #e5e7eb;">
                                                                    ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
                                                                <th
                                                                    style="padding: 0.75rem; border-bottom: 2px solid #e5e7eb;">
                                                                    ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                                                                <th
                                                                    style="padding: 0.75rem; border-bottom: 2px solid #e5e7eb;">
                                                                    ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
                                                                <th
                                                                    style="padding: 0.75rem; border-bottom: 2px solid #e5e7eb; color: var(--primary-color);">
                                                                    ‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤ (Man-Days)</th>
                                                                <th
                                                                    style="padding: 0.75rem; border-bottom: 2px solid #e5e7eb;">
                                                                    ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <% estimations.forEach(est=> { %>
                                                                <tr style="border-bottom: 1px solid #e5e7eb;">
                                                                    <td style="padding: 0.75rem;">
                                                                        <%= est.client_name %>
                                                                    </td>
                                                                    <td style="padding: 0.75rem;">
                                                                        <span
                                                                            style="font-size: 0.85rem; font-weight: bold;">
                                                                            <%= est.device_type %>
                                                                        </span><br>
                                                                        <span
                                                                            style="font-size: 0.75rem; color: #6b7280;">
                                                                            <%= est.test_type %>
                                                                        </span>
                                                                    </td>
                                                                    <td style="padding: 0.75rem;">
                                                                        functions: <%= est.function_count %><br>
                                                                            platform: <%= est.platform_count %>
                                                                    </td>
                                                                    <td
                                                                        style="padding: 0.75rem; font-size: 1.1rem; font-weight: bold; color: var(--primary-color);">
                                                                        <%= est.estimated_days %> ‡∏ß‡∏±‡∏ô
                                                                    </td>
                                                                    <td style="padding: 0.75rem;">
                                                                        <a href="/dashboard/delete/<%= est.id %>"
                                                                            style="color: var(--danger-color); text-decoration: none; font-size: 0.9rem;"
                                                                            onclick="return confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•?');">‡∏•‡∏ö</a>
                                                                    </td>
                                                                </tr>
                                                                <% }) %>
                                                        </tbody>
                                                    </table>
                                                </div>
                                                <% } else { %>
                                                    <p style="text-align: center; margin-top: 2rem;">
                                                        ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</p>
                                                    <% } %>
                                        </div>
        </div>
    </div>
</body>

</html>